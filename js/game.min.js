!function(){me.debug=me.debug||{},debugPanel=me.plugin.Base.extend({GUID:null,area:{},rect:null,z:1/0,visible:!1,version:"0.9.9",init:function(a,b){this.parent(),this.rect=new me.Rect(new me.Vector2d(0,0),me.video.getWidth(),35),this.GUID="debug-"+me.utils.createGUID(),this.name="me.debugPanel",this.isPersistent=!0,this.floating=!0,this.isRenderable=!0,this.alwaysUpdate=!0,this.font=new me.Font("courier",10,"white"),this.area.renderHitBox=new me.Rect(new me.Vector2d(160,5),15,15),this.area.renderVelocity=new me.Rect(new me.Vector2d(165,18),15,15),this.area.renderDirty=new me.Rect(new me.Vector2d(270,5),15,15),this.area.renderCollisionMap=new me.Rect(new me.Vector2d(270,18),15,15),this.help_str="(s)how/(h)ide",this.help_str_len=this.font.measureText(me.video.getSystemContext(),this.help_str).width,this.fps_str_len=this.font.measureText(me.video.getSystemContext(),"00/00 fps").width,me.debug.displayFPS=!0,me.input.bindKey(a||me.input.KEY.S,"show"),me.input.bindKey(b||me.input.KEY.H,"hide"),this.samples=[],this.patchSystemFn(),this.show()},patchSystemFn:function(){me.debug.renderHitBox=me.debug.renderHitBox||!1,me.debug.renderVelocity=me.debug.renderVelocity||!1,me.plugin.patch(me.timer,"update",function(){this.parent(),me.timer.countFPS()}),me.plugin.patch(me.SpriteObject,"draw",function(a){this.parent(a),me.debug.renderHitBox&&(a.strokeStyle="green",a.strokeRect(this.left,this.top,this.width,this.height))}),me.plugin.patch(me.ObjectEntity,"draw",function(a){if(this.parent(a),me.debug.renderHitBox&&this.shapes.length&&(this.collisionBox.draw(a,"red"),"Rectangle"!==this.shapes[0].shapeType&&(a.translate(this.pos.x,this.pos.y),this.shapes[0].draw(a,"red"),a.translate(-this.pos.x,-this.pos.y))),me.debug.renderVelocity){var b=~~(this.pos.x+this.hWidth),c=~~(this.pos.y+this.hHeight);a.strokeStyle="blue",a.lineWidth=1,a.beginPath(),a.moveTo(b,c),a.lineTo(b+~~(this.vel.x*this.hWidth),c+~~(this.vel.y*this.hHeight)),a.stroke()}})},show:function(){this.visible||(me.game.getEntityByName("me.debugPanel")[0]||(me.game.add(this,this.z),me.game.sort()),me.input.registerPointerEvent("mousedown",this.rect,this.onClick.bind(this),!0),this.visible=!0,me.game.repaint())},hide:function(){this.visible&&(me.input.releasePointerEvent("mousedown",this.rect),this.visible=!1,me.game.repaint())},update:function(){return me.input.isKeyPressed("show")?this.show():me.input.isKeyPressed("hide")&&this.hide(),!0},getRect:function(){return this.rect},onClick:function(a){this.area.renderHitBox.containsPoint(a.gameX,a.gameY)?me.debug.renderHitBox=!me.debug.renderHitBox:this.area.renderCollisionMap.containsPoint(a.gameX,a.gameY)?me.debug.renderCollisionMap=!me.debug.renderCollisionMap:this.area.renderVelocity.containsPoint(a.gameX,a.gameY)&&(me.debug.renderVelocity=!me.debug.renderVelocity),me.game.repaint()},drawMemoryGraph:function(a,b,c){if(window.performance&&window.performance.memory){var d=Number.prototype.round(window.performance.memory.usedJSHeapSize/1048576,2),e=Number.prototype.round(window.performance.memory.totalJSHeapSize/1048576,2),f=c-b;this.samples.shift(),this.samples[f]=d/e*25;for(var g=f;g--;){var h=c-(f-g);a.beginPath(),a.strokeStyle="lightgreen",a.moveTo(h,30),a.lineTo(h,30-(this.samples[g]||0)),a.stroke()}this.font.draw(a,d+"/"+e+" MB",b,18)}else this.font.draw(a,"??/?? MB",b,18)},draw:function(a){a.save(),a.globalAlpha=.5,a.fillStyle="black",a.fillRect(this.rect.left,this.rect.top,this.rect.width,this.rect.height),a.globalAlpha=1,this.font.draw(a,"#objects : "+me.game.world.children.length,5,5),this.font.draw(a,"#draws   : "+me.game.world.drawCount,5,18),this.font.draw(a,"?hitbox   ["+(me.debug.renderHitBox?"x":" ")+"]",100,5),this.font.draw(a,"?velocity ["+(me.debug.renderVelocity?"x":" ")+"]",100,18),this.font.draw(a,"?dirtyRect  [ ]",200,5),this.font.draw(a,"?col. layer ["+(me.debug.renderCollisionMap?"x":" ")+"]",200,18),this.drawMemoryGraph(a,300,this.rect.width-this.help_str_len-5),this.font.draw(a,this.help_str,this.rect.width-this.help_str_len-5,18);var b=""+me.timer.fps+"/"+me.sys.fps+" fps";this.font.draw(a,b,this.rect.width-this.fps_str_len-5,5),a.restore()},onDestroyEvent:function(){this.hide(),me.input.unbindKey(me.input.KEY.S),me.input.unbindKey(me.input.KEY.H)}})}(window);var game={data:{score:0},onload:function(){return me.video.init("screen",450,450,!0,"auto")?("#debug"===document.location.hash&&window.onReady(function(){me.plugin.register.defer(debugPanel,"debug")}),me.debug.renderHitBox=!0,me.audio.init("mp3,ogg"),me.loader.onload=this.loaded.bind(this),me.loader.preload(game.resources),me.state.change(me.state.LOADING),void 0):(alert("Your browser does not support HTML5 canvas."),void 0)},loaded:function(){me.state.set(me.state.PLAY,new game.PlayScreen),me.state.set(me.state.MENU,new game.TitleScreen),me.state.set(game.BREIFING_STATE,new game.SplashScreen("splash2",me.state.PLAY)),me.state.set(me.state.GAME_END,new game.SplashScreen("splash3",me.state.MENU)),me.entityPool.add("player",game.PlayerEntity),me.entityPool.add("finish",game.Finish),me.entityPool.add("generator",game.Generator),me.entityPool.add("trap",game.Trap),me.entityPool.add("moving_block",game.MovingBlock),me.entityPool.add("vent",game.Fan),me.sys.gravity=0,me.game.world.sortOn="y",me.input.bindKey(me.input.KEY.LEFT,"left",!0),me.input.bindKey(me.input.KEY.RIGHT,"right",!0),me.input.bindKey(me.input.KEY.UP,"up",!0),me.input.bindKey(me.input.KEY.DOWN,"down",!0),me.input.bindKey(me.input.KEY.CTRL,"shoot",!0),me.input.bindKey(me.input.KEY.SPACE,"stop",!0),me.input.bindKey(me.input.KEY.R,"restart",!0),me.state.change(me.state.MENU)},resetHUD:function(){me.state.current().HUD.enableAllButtons()},restartLevel:function(){this.resetHUD(),me.levelDirector.reloadLevel()},BREIFING_STATE:me.state.USER+1};game.resources=[{name:"walls",type:"image",src:"data/img/walls.png"},{name:"floor",type:"image",src:"data/img/floor.png"},{name:"player",type:"image",src:"data/img/player.png"},{name:"bullet",type:"image",src:"data/img/bullet.png"},{name:"generator",type:"image",src:"data/img/generator.png"},{name:"moving_block",type:"image",src:"data/img/moving_block.png"},{name:"buttons",type:"image",src:"data/img/buttons.png"},{name:"splash",type:"image",src:"data/img/splash.png"},{name:"splash2",type:"image",src:"data/img/splash2.png"},{name:"splash3",type:"image",src:"data/img/splash3.png"},{name:"anykey",type:"image",src:"data/img/anykey.png"},{name:"fan",type:"image",src:"data/img/fan.png"},{name:"0",type:"tmx",src:"data/map/0.tmx"},{name:"1",type:"tmx",src:"data/map/1.tmx"},{name:"2",type:"tmx",src:"data/map/2.tmx"},{name:"3",type:"tmx",src:"data/map/3.tmx"},{name:"4",type:"tmx",src:"data/map/4.tmx"},{name:"5",type:"tmx",src:"data/map/5.tmx"},{name:"6",type:"tmx",src:"data/map/6.tmx"},{name:"8",type:"tmx",src:"data/map/8.tmx"},{name:"9",type:"tmx",src:"data/map/9.tmx"},{name:"10",type:"tmx",src:"data/map/10.tmx"},{name:"11",type:"tmx",src:"data/map/11.tmx"},{name:"12",type:"tmx",src:"data/map/12.tmx"},{name:"13",type:"tmx",src:"data/map/13.tmx"},{name:"14",type:"tmx",src:"data/map/14.tmx"},{name:"007",type:"audio",src:"data/bgm/",channel:1},{name:"crate_move",type:"audio",src:"data/sfx/",channel:2},{name:"shot",type:"audio",src:"data/sfx/",channel:2},{name:"teleport",type:"audio",src:"data/sfx/",channel:2},{name:"gate",type:"audio",src:"data/sfx/",channel:2}],game.EPS=.001,game.movingPlatforms=0,game.bullets=0,game.tweenTime=function(a,b,c){var d=a.x-b.x,e=a.y-b.y,f=Math.sqrt(d*d+e*e);return f/c*1e3},game.PlayerEntity=me.ObjectEntity.extend({init:function(a,b,c){c.image="player",c.spritewidth=50,c.type="player",this.parent(a,b,c),this.updateColRect(0,50,25,50),this.renderable.addAnimation("side",[0,1,2,3]),this.renderable.addAnimation("down",[4,5,6,7]),this.renderable.addAnimation("up",[8,9,10,11]),this._performed={},this._stops=!1},update:function(){if(me.input.isKeyPressed("restart"))return game.restartLevel(),void 0;0===game.movingPlatforms&&0===game.bullets&&(this._isStopped()?(this._onKeyOnce("left",function(){this.flipX(!0),this.renderable.setCurrentAnimation("side"),this.vel.x=-2}),this._onKeyOnce("right",function(){this.flipX(!1),this.renderable.setCurrentAnimation("side"),this.vel.x=2}),this._onKeyOnce("up",function(){this.renderable.setCurrentAnimation("up"),this.vel.y=-2}),this._onKeyOnce("down",function(){this.renderable.setCurrentAnimation("down"),this.vel.y=2}),this._onKeyOnce("shoot",this._shoot)):this._onKeyOnce("stop",this._stop)),this.updateMovement(),Math.abs(this.vel.y)>game.EPS&&me.game.world.sort(!0),this.collideType("finish")&&(game.resetHUD(),me.audio.play("teleport"),"14"===me.levelDirector.getCurrentLevelId()?me.state.change(me.state.GAME_END):me.levelDirector.nextLevel());var a=this.collideType("moving_block",!1);return a?(this.collidable=!1,this.pos.sub(a)):this.collidable=!0,me.game.sort(),0!==this.vel.x||0!==this.vel.y||this._stops?(this.parent(),this.vel.y>0,!0):!1},_isStopped:function(){return Math.abs(this.vel.x)<game.EPS&&Math.abs(this.vel.y)<game.EPS&&!this._stops},_onKeyOnce:function(a,b){me.input.isKeyPressed(a)&&!this._performed[a]&&(b.call(this),this._performed[a]=!0,me.state.current().HUD.disableButton(a))},_shoot:function(){me.audio.play("shot"),["up","down","left","right"].forEach(function(a){var b=new game.Bullet(this,a);me.game.add(b,this.z)},this)},_stop:function(){var a,b=me.game.currentLevel.getLayerByName("floor");this.vel.x>game.EPS?a={x:b.getTile(this.collisionBox.right,this.pos.y).pos.x,y:this.pos.y}:this.vel.x<-game.EPS?a={x:b.getTile(this.collisionBox.left,this.pos.y).pos.x,y:this.pos.y}:this.vel.y>game.EPS?a={x:this.pos.x,y:b.getTile(this.pos.x,this.collisionBox.bottom).pos.y-25}:this.vel.y<-game.EPS&&(a={x:this.pos.x,y:b.getTile(this.pos.x,this.collisionBox.top).pos.y-25});{var c=this.pos.x-a.x,d=this.pos.y-a.y;Math.sqrt(c*c+d*d)}this._stops=!0,new me.Tween(this.pos).to(a,game.tweenTime(this.pos,a,120)).onComplete(function(){this._stops=!1}.bind(this)).start(),this.vel.x=this.vel.y=0}}),game.BULLET_TYPE=10,game.Bullet=me.ObjectEntity.extend({init:function(a,b){this.parent(a.left+a.width/2,a.top+a.height/2,{image:"bullet",type:game.BULLET_TYPE,spritewidth:15,spriteheight:15}),this.collidable=!1,game.bullets++,this._direction=b,"up"===b&&(this.pos.y=a.top,this.vel.y=-15),"down"===b&&(this.pos.y=a.bottom,this.vel.y=15),"left"===b&&(this.pos.x=a.left,this.vel.x=-15),"right"===b&&(this.pos.x=a.right,this.vel.x=15)},update:function(){this.updateMovement();var a=this.collideType("generator");a&&"generator"===a.type&&(this._die(),a.obj.explode());var b=me.game.collisionMap.getTile(this.pos.x,this.pos.y);return this.alive&&b&&!this._isWater(b)&&this._die(),!0},_die:function(){this.collidable=!1,this.alive=!1,me.game.remove(this),game.bullets--},_isWater:function(a){return!!a.tileset.TileProperties[a.tileId].water}}),game.Finish=me.ObjectEntity.extend({init:function(a,b,c){c.type="finish",this.parent(a,b,c),this.updateColRect(15,20,15,20)}}),game.Generator=me.ObjectEntity.extend({init:function(a,b,c){c.image="generator",c.type="generator",c.spritewidth=50,this.parent(a,b,c),this.updateColRect(0,50,25,50),this._activate=c.activate,this.renderable.setAnimationFrame(1)},update:function(){return!0},explode:function(){this.renderable.setAnimationFrame(0),me.game.getEntityByProp("objectId",this._activate).forEach(function(a){a.activate()})}}),game.ActiveObject=me.ObjectEntity.extend({init:function(a,b,c){this.parent(a,b,c),this.objectId=c.id},activate:function(){throw new Error("activate is not implemented")}}),game.CLOSED_TRAP_TILE=12,game.Trap=game.ActiveObject.extend({activate:function(){var a=me.game.collisionMap,b=me.game.currentLevel.getLayerByName("floor"),c=a.getTile(this.pos.x,this.pos.y);a.clearTile(c.col,c.row),b.setTile(c.col,c.row,game.CLOSED_TRAP_TILE),me.audio.play("gate")}}),game.MovingBlock=game.ActiveObject.extend({init:function(a,b,c){c.image="moving_block",c.type="moving_block",this.parent(a,b,c),this.updateColRect(0,50,25,50),this._direction=c.direction,this._offset=1*c.offset},activate:function(){var a=me.game.collisionMap,b=a.getTile(this.pos.x,this.pos.y+25),c=this._getDest(b);this._moving=!0,0===game.movingPlatforms&&me.audio.play("crate_move"),game.movingPlatforms++;var d={x:c.col*me.game.currentLevel.tilewidth,y:c.row*me.game.currentLevel.tileheight-25};new me.Tween(this.pos).to(d,game.tweenTime(this.pos,d,250)).onComplete(function(){a.clearTile(b.col,b.row),a.setTile(c.col,c.row,a.tileset.firstgid),game.movingPlatforms--,this._moving=!1}.bind(this)).start()},update:function(){return this._moving},_getDest:function(a){return"up"===this._direction?{row:a.row-this._offset,col:a.col}:"down"===this._direction?{row:a.row+this._offset,col:a.col}:"left"===this._direction?{row:a.row,col:a.col-this._offset}:{row:a.row,col:a.col+this._offset}}}),game.Fan=me.ObjectEntity.extend({init:function(a,b,c){c.image="fan",c.spritewidth=50,this.parent(a,b,c)}}),game.HUD=game.HUD||{},game.HUD.Container=me.ObjectContainer.extend({init:function(){this.parent(),this.isPersistent=!0,this.collidable=!1,this.floating=!0,this.z=1/0,this.name="HUD";var a=59;this._buttons=["left","up","down","right","shoot","stop","restart"].reduce(function(b,c){var d=new game.HUD.ButtonItem(a,405,c);return this.addChild(d),a+=d.width+2,b[c]=d,b}.bind(this),{})},disableButton:function(a){this._buttons[a].off()},enableAllButtons:function(){Object.keys(this._buttons).forEach(function(a){this._buttons[a].on()},this)}}),game.HUD.ButtonItem=me.AnimationSheet.extend({_anims:{on:{shoot:[0],left:[1],up:[2],down:[3],right:[4],restart:[5],stop:[3]},off:{shoot:[8],left:[9],up:[10],down:[11],right:[12],restart:[13],stop:[7]}},init:function(a,b,c){this.parent(a,b,me.loader.getImage("buttons"),"stop"===c?80:40,40),this.addAnimation("on",this._anims.on[c]),this.addAnimation("off",this._anims.off[c]),this.on()},on:function(){this.setCurrentAnimation("on")},off:function(){this.setCurrentAnimation("off")}}),game.HUD.ScoreItem=me.Renderable.extend({init:function(a,b){this.parent(new me.Vector2d(a,b),10,10),this.score=-1,this.floating=!0},update:function(){return this.score!==game.data.score?(this.score=game.data.score,!0):!1},draw:function(){}}),game.SplashScreen=me.ScreenObject.extend({init:function(a,b){this.image=a,this.nextState=b,this.parent(!0),this._startGame=this._startGame.bind(this)},onResetEvent:function(){this.splash=me.loader.getImage(this.image),window.addEventListener("keydown",this._startGame,!1)},draw:function(a){a.drawImage(this.splash,0,0)},_startGame:function(){me.state.change(this.nextState)},onDestroyEvent:function(){window.removeEventListener("keydown",this._startGame)}}),game.TitleScreen=game.SplashScreen.extend({init:function(){this.parent("splash",game.BREIFING_STATE)},onResetEvent:function(){this.parent(),this.anykey=me.loader.getImage("anykey"),this.lastUpdate=0,this.drawAnyKey=!0,me.audio.playTrack("007")},draw:function(a){this.parent(a),this.drawAnyKey&&a.drawImage(this.anykey,93,390)},update:function(){return this.lastUpdate+=me.timer.tick,this.lastUpdate>20?(this.lastUpdate=0,this.drawAnyKey=!this.drawAnyKey,!0):void 0}}),game.PlayScreen=me.ScreenObject.extend({onResetEvent:function(){me.levelDirector.loadLevel("0"),game.data.score=0,this.HUD=new game.HUD.Container;var a=new me.ColorLayer("back","#000000",-1/0);a.floating=!0,me.game.world.addChild(a),me.game.world.addChild(this.HUD)},onDestroyEvent:function(){me.game.world.removeChild(this.HUD),me.audio.stopTrack()}});